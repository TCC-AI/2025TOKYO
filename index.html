<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京五日遊行程規劃</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ==================== CSS 樣式 ==================== */
        
        /* 基本樣式設定 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 頭部樣式 */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* 導航選單 */
        .nav-menu {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* 主要內容區 */
        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 日期選擇器 */
        .day-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .day-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .day-btn:hover, .day-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            transform: scale(1.05);
        }

        /* 每日行程內容 */
        .day-content {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .itinerary-item {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
            transition: transform 0.2s ease;
        }

        .itinerary-item:hover {
            transform: translateX(5px);
        }

        .itinerary-item h3 {
            color: #007bff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .itinerary-item .time {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .transport-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #ffc107;
        }

        .transport-info h4 {
            color: #856404;
            margin-bottom: 8px;
        }

        .food-info {
            background: #d1ecf1;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #17a2b8;
        }

        .food-info strong {
            color: #0c5460;
        }

        /* 交通指南樣式 */
        .transport-section {
            margin-bottom: 40px;
        }

        .ticket-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ticket-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .ticket-card:hover {
            transform: translateY(-5px);
        }

        .ticket-card h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .ticket-card .price {
            font-size: 2rem;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* 路線規劃器 */
        .route-planner {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }

        .route-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .route-form input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .route-result {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        /* 預算計算器 */
        .budget-calculator h2 {
            margin-bottom: 25px;
            color: #495057;
        }

        .budget-form .budget-item {
            margin-bottom: 20px;
        }

        .budget-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .budget-form input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            width: 100px;
        }

        .budget-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #dee2e6;
        }

        .category h3 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .expense-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            text-align: right;
        }

        .budget-summary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .total-budget h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        #total-amount, #per-person-amount {
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* 待辦清單 */
        .checklist-section h2 {
            margin-bottom: 25px;
            color: #495057;
        }

        .checklist-category {
            margin-bottom: 30px;
        }

        .checklist-category h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            background: #f8f9fa;
            padding-left: 10px;
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }

        .checklist-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .checklist-item .delete-btn {
            margin-left: auto;
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .checklist-item:hover .delete-btn {
            opacity: 1;
        }

        .add-item-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .add-item-form input, .add-item-form select {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
        }

        .add-item-form input {
            flex: 1;
            min-width: 250px;
        }

        /* 旅遊筆記 */
        .notes-section h2 {
            margin-bottom: 25px;
            color: #495057;
        }

        .note-form {
            margin-bottom: 30px;
        }

        .note-form input, .note-form textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .note-form textarea {
            min-height: 120px;
            resize: vertical;
        }

        .note-item {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .note-item h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .note-item .note-date {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .note-item .note-content {
            line-height: 1.6;
        }

        .note-item .note-actions {
            margin-top: 15px;
            text-align: right;
        }

        .note-item .delete-note-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* 浮動操作按鈕 */
        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .fab:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }

        /* 載入動畫 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 成功/錯誤訊息 */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            animation: slideIn 0.5s ease;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .nav-menu {
                gap: 5px;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
            }
            
            .route-form {
                flex-direction: column;
            }
            
            .route-form input {
                min-width: auto;
            }
            
            .floating-actions {
                bottom: 20px;
                right: 20px;
            }
            
            .budget-categories {
                grid-template-columns: 1fr;
            }
            
            .ticket-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .day-selector {
                gap: 5px;
            }
            
            .day-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .add-item-form {
                flex-direction: column;
            }
            
            .add-item-form input {
                min-width: auto;
            }
        }

        /* 隱藏類別 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頭部導航 -->
        <header class="header">
            <h1><i class="fas fa-torii-gate"></i> 東京五日遊行程</h1>
            <p>2025/07/20-24 完整攻略</p>
        </header>

        <!-- 功能選單 -->
        <nav class="nav-menu">
            <button class="nav-btn active" data-tab="itinerary">
                <i class="fas fa-calendar-alt"></i> 行程總覽
            </button>
            <button class="nav-btn" data-tab="transport">
                <i class="fas fa-train"></i> 交通指南
            </button>
            <button class="nav-btn" data-tab="budget">
                <i class="fas fa-yen-sign"></i> 預算計算
            </button>
            <button class="nav-btn" data-tab="checklist">
                <i class="fas fa-check-square"></i> 待辦清單
            </button>
            <button class="nav-btn" data-tab="notes">
                <i class="fas fa-sticky-note"></i> 旅遊筆記
            </button>
        </nav>

        <!-- 主要內容區 -->
        <main class="main-content">
            <!-- 行程總覽頁面 -->
            <div id="itinerary" class="tab-content active">
                <div class="day-selector">
                    <button class="day-btn active" data-day="1">Day 1</button>
                    <button class="day-btn" data-day="2">Day 2</button>
                    <button class="day-btn" data-day="3">Day 3</button>
                    <button class="day-btn" data-day="4">Day 4</button>
                    <button class="day-btn" data-day="5">Day 5</button>
                </div>
                
                <div id="day-content" class="day-content">
                    <!-- 動態載入每日行程 -->
                </div>
            </div>

            <!-- 交通指南頁面 -->
            <div id="transport" class="tab-content">
                <div class="transport-section">
                    <h2><i class="fas fa-route"></i> 交通票券建議</h2>
                    <div class="ticket-cards">
                        <div class="ticket-card">
                            <h3>JR Narita Express 來回券</h3>
                            <p class="price">¥4,070</p>
                            <p>成田機場 ↔ 新宿站<br>約80分鐘車程</p>
                        </div>
                        <div class="ticket-card">
                            <h3>Welcome Suica</h3>
                            <p class="price">¥2,000</p>
                            <p>含¥1,500儲值，28天有效<br>可搭所有交通工具</p>
                        </div>
                        <div class="ticket-card">
                            <h3>迪士尼度假區線</h3>
                            <p class="price">¥660</p>
                            <p>舞濱站 ↔ 迪士尼樂園<br>一日無限搭乘</p>
                        </div>
                    </div>
                </div>
                
                <div class="route-planner">
                    <h2><i class="fas fa-map-marked-alt"></i> 路線規劃器</h2>
                    <div class="route-form">
                        <input type="text" id="from-station" placeholder="出發站 (例: 新宿)">
                        <input type="text" id="to-station" placeholder="目的地 (例: 淺草)">
                        <button id="search-route" class="btn-primary">
                            <i class="fas fa-search"></i> 查詢路線
                        </button>
                    </div>
                    <div id="route-result" class="route-result hidden">
                        <!-- 路線結果顯示區 -->
                    </div>
                </div>
            </div>

            <!-- 預算計算頁面 -->
            <div id="budget" class="tab-content">
                <div class="budget-calculator">
                    <h2><i class="fas fa-calculator"></i> 預算計算器</h2>
                    <div class="budget-form">
                        <div class="budget-item">
                            <label>旅遊人數</label>
                            <input type="number" id="people-count" value="1" min="1" max="10">
                        </div>
                        <div class="budget-categories">
                            <div class="category">
                                <h3><i class="fas fa-plane"></i> 交通費用</h3>
                                <div class="expense-item">
                                    <span>機票</span>
                                    <input type="number" class="expense-input" data-category="transport" value="15000">
                                </div>
                                <div class="expense-item">
                                    <span>當地交通</span>
                                    <input type="number" class="expense-input" data-category="transport" value="6000">
                                </div>
                            </div>
                            <div class="category">
                                <h3><i class="fas fa-bed"></i> 住宿費用</h3>
                                <div class="expense-item">
                                    <span>飯店 (5晚)</span>
                                    <input type="number" class="expense-input" data-category="accommodation" value="25000">
                                </div>
                            </div>
                            <div class="category">
                                <h3><i class="fas fa-utensils"></i> 餐飲費用</h3>
                                <div class="expense-item">
                                    <span>餐費 (5天)</span>
                                    <input type="number" class="expense-input" data-category="food" value="15000">
                                </div>
                            </div>
                            <div class="category">
                                <h3><i class="fas fa-ticket-alt"></i> 門票費用</h3>
                                <div class="expense-item">
                                    <span>迪士尼</span>
                                    <input type="number" class="expense-input" data-category="tickets" value="10900">
                                </div>
                                <div class="expense-item">
                                    <span>其他景點</span>
                                    <input type="number" class="expense-input" data-category="tickets" value="5200">
                                </div>
                            </div>
                            <div class="category">
                                <h3><i class="fas fa-shopping-bag"></i> 購物預算</h3>
                                <div class="expense-item">
                                    <span>購物</span>
                                    <input type="number" class="expense-input" data-category="shopping" value="30000">
                                </div>
                            </div>
                        </div>
                        <div class="budget-summary">
                            <div class="total-budget">
                                <h3>總預算：<span id="total-amount">¥107,100</span></h3>
                                <p>每人平均：<span id="per-person-amount">¥107,100</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 待辦清單頁面 -->
            <div id="checklist" class="tab-content">
                <div class="checklist-section">
                    <h2><i class="fas fa-tasks"></i> 出發前準備</h2>
                    <div class="checklist-category">
                        <h3><i class="fas fa-globe"></i> 線上預約 (出發前60天)</h3>
                        <div class="checklist-items" id="online-booking">
                            <!-- 動態載入待辦事項 -->
                        </div>
                    </div>
                    <div class="checklist-category">
                        <h3><i class="fas fa-suitcase"></i> 行李準備</h3>
                        <div class="checklist-items" id="packing-list">
                            <!-- 動態載入待辦事項 -->
                        </div>
                    </div>
                    <div class="checklist-category">
                        <h3><i class="fas fa-passport"></i> 證件文件</h3>
                        <div class="checklist-items" id="documents">
                            <!-- 動態載入待辦事項 -->
                        </div>
                    </div>
                    <div class="add-item-form">
                        <input type="text" id="new-item" placeholder="新增待辦事項...">
                        <select id="item-category">
                            <option value="online-booking">線上預約</option>
                            <option value="packing-list">行李準備</option>
                            <option value="documents">證件文件</option>
                        </select>
                        <button id="add-item" class="btn-primary">
                            <i class="fas fa-plus"></i> 新增
                        </button>
                    </div>
                </div>
            </div>

            <!-- 旅遊筆記頁面 -->
            <div id="notes" class="tab-content">
                <div class="notes-section">
                    <h2><i class="fas fa-pen"></i> 旅遊筆記</h2>
                    <div class="note-form">
                        <input type="text" id="note-title" placeholder="筆記標題">
                        <textarea id="note-content" placeholder="記錄你的旅遊心得、重要提醒或臨時變更..."></textarea>
                        <button id="save-note" class="btn-primary">
                            <i class="fas fa-save"></i> 儲存筆記
                        </button>
                    </div>
                    <div id="notes-list" class="notes-list">
                        <!-- 動態載入筆記列表 -->
                    </div>
                </div>
            </div>
        </main>

        <!-- 浮動操作按鈕 -->
        <div class="floating-actions">
            <button id="share-btn" class="fab" title="分享行程">
                <i class="fas fa-share-alt"></i>
            </button>
            <button id="offline-btn" class="fab" title="離線下載">
                <i class="fas fa-download"></i>
                          </button>
        </div>

        <!-- 載入中動畫 -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>載入中...</p>
        </div>
    </div>

    <script>
        // ==================== JavaScript 代碼 ==================== 
        
        // 全域變數
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzir6zZdoSRuSV3o4h7JrJsgF5JW3rm_H64IbjOehy2ocrPZ-K-XO2xb5llBxmIVIs/exec';
        let currentDay = 1;
        let budgetData = {};
        let checklistData = {};
        let notesData = [];

        // 行程資料
        const ITINERARY_DATA = {
            1: {
                title: "Day 1 - 抵達東京・輕鬆適應",
                date: "07/20 (日)",
                items: [
                    {
                        time: "10:40",
                        title: "JX802 起飛",
                        description: "星宇航空從桃園出發",
                        transport: null,
                        food: "機上餐"
                    },
                    {
                        time: "15:05",
                        title: "抵達成田機場",
                        description: "入境提領行李，預計16:00完成",
                        transport: null,
                        food: null
                    },
                    {
                        time: "16:15",
                        title: "前往新宿",
                        description: "搭乘成田特快前往新宿",
                        transport: {
                            method: "🚄 JR Narita Express",
                            duration: "約80分鐘",
                            cost: "¥3,070",
                            route: "成田機場 → 新宿站"
                        },
                        food: null
                    },
                    {
                        time: "17:45",
                        title: "GROOVE飯店 Check-in",
                        description: "抵達新宿，辦理入住手續",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "約3分鐘",
                            cost: "免費",
                            route: "新宿站南口 → GROOVE飯店"
                        },
                        food: null
                    },
                    {
                        time: "18:30",
                        title: "房間休息",
                        description: "調整時差，欣賞高樓夜景",
                        transport: null,
                        food: null
                    },
                    {
                        time: "19:30-22:00",
                        title: "歌舞伎町散步",
                        description: "體驗東京夜生活，思出橫丁晚餐",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "2-8分鐘",
                            cost: "免費",
                            route: "飯店周邊步行範圍"
                        },
                        food: "思出橫丁「鳥園」"
                    }
                ]
            },
            2: {
                title: "Day 2 - 下町文化 + 現代藝術",
                date: "07/21 (一)",
                items: [
                    {
                        time: "07:30",
                        title: "飯店早餐",
                        description: "在飯店享用早餐",
                        transport: null,
                        food: "飯店早餐"
                    },
                    {
                        time: "09:00",
                        title: "前往淺草",
                        description: "搭乘電車前往淺草寺",
                        transport: {
                            method: "🚇 JR+都營淺草線",
                            duration: "約35分鐘",
                            cost: "¥200",
                            route: "新宿 → 新橋 → 淺草"
                        },
                        food: null
                    },
                    {
                        time: "09:30-11:00",
                        title: "淺草寺參拜",
                        description: "雷門拍照，仲見世通購物",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "出站即達",
                            cost: "免費",
                            route: "淺草站 → 雷門 → 淺草寺"
                        },
                        food: "人形燒"
                    },
                    {
                        time: "11:15",
                        title: "隅田川水上巴士",
                        description: "搭乘水上巴士前往濱離宮",
                        transport: {
                            method: "🚢 水上巴士",
                            duration: "約35分鐘",
                            cost: "¥1,040",
                            route: "淺草碼頭 → 濱離宮碼頭"
                        },
                        food: null
                    },
                    {
                        time: "12:00-13:30",
                        title: "濱離宮恩賜庭園",
                        description: "日式庭園散步，欣賞東京灣景色",
                        transport: {
                            method: "🚶‍♂️ 碼頭直達",
                            duration: "即達",
                            cost: "入園¥300",
                            route: "碼頭 → 庭園入口"
                        },
                        food: null
                    },
                    {
                        time: "14:00-15:30",
                        title: "築地場外市場",
                        description: "品嚐新鮮海鮮丼",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "約10分鐘",
                            cost: "免費",
                            route: "濱離宮 → 築地場外"
                        },
                        food: "海鮮丼"
                    },
                    {
                        time: "16:30-19:00",
                        title: "teamLab Planets 豊洲",
                        description: "沉浸式數位藝術體驗",
                        transport: {
                            method: "🚇 都營+百合海鷗線",
                            duration: "約25分鐘",
                            cost: "¥320",
                            route: "築地 → 新橋 → 豊洲"
                        },
                        food: null
                    },
                    {
                        time: "20:00",
                        title: "回新宿晚餐",
                        description: "回到新宿享用拉麵",
                        transport: {
                            method: "🚇 百合海鷗線+JR",
                            duration: "約35分鐘",
                            cost: "¥320",
                            route: "豊洲 → 新橋 → 新宿"
                        },
                        food: "一蘭拉麵"
                    }
                ]
            },
            3: {
                title: "Day 3 - 原宿澀谷潮流 + 轉住Gracery",
                date: "07/22 (二)",
                items: [
                    {
                        time: "07:30",
                        title: "GROOVE 退房",
                        description: "退房後步行至 Gracery 寄行李",
                        transport: {
                            method: "🚶‍♂️ 步行/計程車",
                            duration: "約8分鐘",
                            cost: "步行免費/計程車¥730",
                            route: "GROOVE → Gracery"
                        },
                        food: "便利店早餐"
                    },
                    {
                        time: "08:00",
                        title: "前往原宿",
                        description: "搭乘山手線前往原宿站",
                        transport: {
                            method: "🚇 JR山手線",
                            duration: "約7分鐘",
                            cost: "¥160",
                            route: "新宿 → 原宿"
                        },
                        food: null
                    },
                    {
                        time: "08:30-10:00",
                        title: "明治神宮參拜",
                        description: "東京最重要的神社參拜",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "約3分鐘",
                            cost: "免費",
                            route: "原宿站西口 → 明治神宮"
                        },
                        food: null
                    },
                    {
                        time: "10:15-11:30",
                        title: "竹下通逛街",
                        description: "青少年文化聖地購物",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "約3分鐘",
                            cost: "免費",
                            route: "明治神宮 → 竹下通"
                        },
                        food: "彩虹棉花糖"
                    },
                    {
                        time: "11:45-14:00",
                        title: "表參道精品街",
                        description: "高級精品購物 + 午餐",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "約10分鐘",
                            cost: "免費",
                            route: "竹下通 → 表參道Hills"
                        },
                        food: "牛かつもと村"
                    },
                    {
                        time: "14:30-16:30",
                        title: "澀谷購物",
                        description: "109、Center Gai 購物",
                        transport: {
                            method: "🚇 東京Metro半藏門線",
                            duration: "約3分鐘",
                            cost: "¥170",
                            route: "表參道 → 澀谷"
                        },
                        food: null
                    },
                    {
                        time: "17:00-18:30",
                        title: "Shibuya Sky 夕陽",
                        description: "澀谷天空展望台看夕陽",
                        transport: {
                            method: "🚶‍♂️ 步行",
                            duration: "約3分鐘",
                            cost: "入場¥2,000",
                            route: "澀谷站 → Sky展望台"
                        },
                        food: null
                    },
                    {
                        time: "18:45",
                        title: "澀谷十字路口",
                        description: "世界最繁忙十字路口拍照",
                        transport: {
                            method: "🚶‍♂️ 下樓即達",
                            duration: "即達",
                            cost: "免費",
                            route: "Sky → 十字路口"
                        },
                        food: null
                    },
                    {
                        time: "19:30",
                        title: "回新宿 Check-in",
                        description: "回到新宿 Gracery 辦理入住",
                        transport: {
                            method: "🚇 JR山手線",
                            duration: "約7分鐘",
                            cost: "¥160",
                            route: "澀谷 → 新宿"
                        },
                        food: "鳥貴族串燒"
                    }
                ]
            },
            4: {
                title: "Day 4 - Tokyo Disneyland 攻略日",
                date: "07/23 (三)",
                items: [
                    {
                        time: "06:30",
                        title: "早餐 + 出發",
                        description: "Gracery早餐後準備出發",
                        transport: null,
                        food: "飯店早餐"
                    },
                    {
                        time: "07:06",
                        title: "前往迪士尼",
                        description: "搭乘JR前往舞濱站",
                        transport: {
                            method: "🚇 JR中央線+京葉線",
                            duration: "約45分鐘",
                            cost: "¥390",
                            route: "新宿 → 東京 → 舞濱"
                        },
                        food: null
                    },
                    {
                        time: "08:00",
                        title: "抵達迪士尼樂園",
                        description: "開園前排隊入場",
                        transport: {
                            method: "🚶‍♂️ 步行/度假區線",
                            duration: "約5分鐘",
                            cost: "步行免費/¥260",
                            route: "舞濱站 → 迪士尼樂園"
                        },
                        food: null
                    },
                    {
                        time: "08:15-12:00",
                        title: "上午高效攻略",
                        description: "從右側開始順時針遊玩熱門設施",
                        transport: {
                            method: "🎢 園區內步行",
                            duration: "善用App查詢",
                            cost: "入園¥10,900",
                            route: "右側→順時針路線"
                        },
                        food: null
                    },
                    {
                        time: "12:00-13:00",
                        title: "Queen of Hearts 午餐",
                        description: "愛麗絲主題餐廳用餐",
                        transport: {
                            method: "🚶‍♂️ 園區內步行",
                            duration: "位於夢幻樂園",
                            cost: "餐費約¥2,500",
                            route: "園區內移動"
                        },
                        food: "主題餐廳套餐"
                    },
                    {
                        time: "13:00-17:30",
                        title: "下午遊玩",
                        description: "室內設施避暑，購物休息",
                        transport: {
                            method: "🎢 園區內移動",
                            duration: "多利用室內設施",
                            cost: "商品費用",
                            route: "園區內各區域"
                        },
                        food: "米奇雞腿"
                    },
                    {
                        time: "18:45",
                        title: "卡位等夜間遊行",
                        description: "在城堡前廣場卡位",
                        transport: {
                            method: "🚶‍♂️ 遊行路線卡位",
                            duration: "提前45分鐘",
                            cost: "免費",
                            route: "城堡前廣場"
                        },
                        food: null
                    },
                    {
                        time: "19:30-20:00",
                        title: "Electrical Parade",
                        description: "東京迪士尼經典夜間遊行",
                        transport: null,
                        food: null
                    },
                    {
                        time: "21:30",
                        title: "回新宿",
                        description: "搭乘JR回到新宿",
                        transport: {
                            method: "🚇 JR京葉線+中央線",
                            duration: "約45分鐘",
                            cost: "¥390",
                            route: "舞濱 → 東京 → 新宿"
                        },
                        food: "山頭火拉麵"
                    }
                ]
            },
            5: {
                title: "Day 5 - 採買返台",
                date: "07/24 (四)",
                items: [
                    {
                        time: "07:30",
                        title: "早餐 + 退房",
                        description: "Gracery早餐後退房寄行李",
                        transport: null,
                        food: "飯店早餐"
                    },
                    {
                        time: "09:00-11:00",
                        title: "最後採買",
                        description: "新宿站周邊最後購物",
                        transport: {
                            method: "🚶‍♂️ 新宿站周邊步行",
                            duration: "全部徒步可達",
                            cost: "免費",
                            route: "BICQLO→Loft→Don Quijote"
                        },
                        food: "哈根達斯"
                    },
                    {
                        time: "11:20",
                        title: "前往成田機場",
                        description: "搭乘成田特快前往機場",
                        transport: {
                            method: "🚄 JR Narita Express",
                            duration: "約80分鐘",
                            cost: "使用來回券",
                            route: "新宿 → 成田機場T2"
                        },
                        food: "N'EX便當"
                    },
                    {
                        time: "13:30",
                        title: "機場報到 + 退稅",
                        description: "星宇櫃檯報到，4F退稅",
                        transport: {
                            method: "🚶‍♂️ 成田T2內移動",
                            duration: "預留充足時間",
                            cost: "免費",
                            route: "D/E區櫃檯→退稅櫃檯"
                        },
                        food: null
                    },
                    {
                        time: "14:30-16:00",
                        title: "免稅店採購",
                        description: "最後伴手禮採購",
                        transport: {
                            method: "🚶‍♂️ 免稅店區域",
                            duration: "預留充足時間",
                            cost: "商品費用",
                            route: "成田機場免稅店"
                        },
                        food: null
                    },
                    {
                        time: "16:20",
                        title: "JX803起飛",
                        description: "星宇航空返回桃園",
                        transport: null,
                        food: "機上餐"
                    },
                    {
                        time: "19:00",
                        title: "抵達桃園",
                        description: "順利返回台灣",
                        transport: {
                            method: "🚄 機捷+高鐵",
                            duration: "可當天回台中",
                            cost: "依個人需求",
                            route: "桃園→台北→台中"
                        },
                        food: null
                    }
                ]
            }
        };

        // 預設待辦清單資料
        const DEFAULT_CHECKLIST = {
            'online-booking': [
                '迪士尼樂園門票預購',
                'teamLab Planets 預約',
                'Shibuya Sky 展望台預約',
                '成田特快 N\'EX 預約指定席',
                '飯店 Check-in 線上辦理',
                '日本上網卡/WiFi機預訂',
                '旅遊保險投保'
            ],
            'packing-list': [
                '護照 (效期6個月以上)',
                '台胞證 (備用)',
                '信用卡 + 現金',
                '充電器 + 行動電源',
                '相機 + 記憶卡',
                '常用藥品',
                '雨傘/雨衣',
                '舒適步行鞋',
                '輕便外套',
                '盥洗用品'
            ],
            'documents': [
                '機票電子票根列印',
                '飯店訂房確認單',
                '旅遊行程表列印',
                '緊急聯絡人資料',
                '重要證件影本',
                '旅遊保險單',
                '信用卡海外刷卡開通',
                '手機漫遊/上網設定'
            ]
        };

        // DOM 載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 初始化應用程式
        function initializeApp() {
            setupEventListeners();
            loadItinerary(1);
            loadBudgetCalculator();
            loadChecklist();
            loadNotes();
        }

        // 設定事件監聽器
        function setupEventListeners() {
            // 導航選單切換
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // 日期選擇器
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const day = parseInt(this.dataset.day);
                    loadItinerary(day);
                });
            });

            // 路線查詢
            document.getElementById('search-route').addEventListener('click', searchRoute);

            // 預算計算
            document.getElementById('people-count').addEventListener('input', calculateBudget);
            document.querySelectorAll('.expense-input').forEach(input => {
                input.addEventListener('input', calculateBudget);
            });

            // 待辦清單
            document.getElementById('add-item').addEventListener('click', addChecklistItem);
            document.getElementById('new-item').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addChecklistItem();
                }
            });

            // 旅遊筆記
            document.getElementById('save-note').addEventListener('click', saveNote);

            // 浮動按鈕
            document.getElementById('share-btn').addEventListener('click', shareItinerary);
            document.getElementById('offline-btn').addEventListener('click', downloadOffline);
        }

        // 切換分頁
        function switchTab(tabName) {
            // 更新導航按鈕狀態
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // 更新內容區域
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // 載入行程內容
        function loadItinerary(day) {
            currentDay = day;
            
            // 更新日期按鈕狀態
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-day="${day}"]`).classList.add('active');

            // 載入行程內容
            const dayData = ITINERARY_DATA[day];
            const contentDiv = document.getElementById('day-content');
            
            if (!dayData) {
                contentDiv.innerHTML = '<p>行程資料載入中...</p>';
                return;
            }

            let html = `
                <div class="day-header">
                    <h2>${dayData.title}</h2>
                    <p class="day-date">${dayData.date}</p>
                </div>
            `;

            dayData.items.forEach(item => {
                html += `
                    <div class="itinerary-item">
                        <h3>
                            <span class="time">${item.time}</span>
                            ${item.title}
                        </h3>
                        <p>${item.description}</p>
                        ${item.transport ? `
                            <div class="transport-info">
                                <h4><i class="fas fa-route"></i> 交通方式</h4>
                                <p><strong>方式：</strong>${item.transport.method}</p>
                                <p><strong>時間：</strong>${item.transport.duration}</p>
                                <p><strong>費用：</strong>${item.transport.cost}</p>
                                <p><strong>路線：</strong>${item.transport.route}</p>
                            </div>
                        ` : ''}
                        ${item.food ? `
                            <div class="food-info">
                                <strong><i class="fas fa-utensils"></i> 餐飲：</strong>${item.food}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            contentDiv.innerHTML = html;
        }

        // 路線查詢功能
        function searchRoute() {
            const fromStation = document.getElementById('from-station').value.trim();
            const toStation = document.getElementById('to-station').value.trim();
            const resultDiv = document.getElementById('route-result');

            if (!fromStation || !toStation) {
                showAlert('請輸入出發站和目的地', 'error');
                return;
            }

            showLoading(true);

            // 模擬路線查詢 (實際應該呼叫 Google Apps Script API)
            setTimeout(() => {
                const mockResult = {
                    routes: [
                        {
                            method: "🚇 JR山手線",
                            duration: "約15分鐘",
                            cost: "¥160",
                            transfers: 0,
                            route: `${fromStation} → ${toStation}`
                        },
                        {
                            method: "🚇 東京Metro + JR",
                            duration: "約20分鐘",
                            cost: "¥200",
                            transfers: 1,
                            route: `${fromStation} → 轉乘站 → ${toStation}`
                        }
                    ]
                };

                let html = '<h3>查詢結果</h3>';
                mockResult.routes.forEach((route, index) => {
                    html += `
                        <div class="route-option" style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #007bff;">
                            <h4>路線 ${index + 1}</h4>
                            <p><strong>方式：</strong>${route.method}</p>
                            <p><strong>時間：</strong>${route.duration}</p>
                            <p><strong>費用：</strong>${route.cost}</p>
                            <p><strong>轉乘：</strong>${route.transfers}次</p>
                            <p><strong>路線：</strong>${route.route}</p>
                        </div>
                    `;
                });

                resultDiv.innerHTML = html;
                resultDiv.classList.remove('hidden');
                showLoading(false);
            }, 1500);
        }

        // 載入預算計算器
        function loadBudgetCalculator() {
            calculateBudget();
        }

        // 計算預算
        function calculateBudget() {
            const peopleCount = parseInt(document.getElementById('people-count').value) || 1;
            let totalAmount = 0;

            document.querySelectorAll('.expense-input').forEach(input => {
                const amount = parseInt(input.value) || 0;
                totalAmount += amount;
            });

            const perPersonAmount = Math.round(totalAmount / peopleCount);

            document.getElementById('total-amount').textContent = `¥${totalAmount.toLocaleString()}`;
            document.getElementById('per-person-amount').textContent = `¥${perPersonAmount.toLocaleString()}`;
        }

        // 載入待辦清單
        function loadChecklist() {
            // 從 localStorage 載入或使用預設資料
            const savedChecklist = localStorage.getItem('tokyo-checklist');
            checklistData = savedChecklist ? JSON.parse(savedChecklist) : DEFAULT_CHECKLIST;

            Object.keys(checklistData).forEach(category => {
                renderChecklistCategory(category);
            });
        }

        // 渲染待辦清單分類
        function renderChecklistCategory(category) {
            const container = document.getElementById(category);
            if (!container) return;

            let html = '';
            checklistData[category].forEach((item, index) => {
                const isCompleted = item.completed || false;
                const itemText = typeof item === 'string' ? item : item.text;
                
                html += `
                    <div class="checklist-item ${isCompleted ? 'completed' : ''}">
                        <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                               onchange="toggleChecklistItem('${category}', ${index})">
                        <span>${itemText}</span>
                        <button class="delete-btn" onclick="deleteChecklistItem('${category}', ${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 新增待辦事項
        function addChecklistItem() {
            const newItemInput = document.getElementById('new-item');
            const categorySelect = document.getElementById('item-category');
                      const itemText = newItemInput.value.trim();
            const category = categorySelect.value;

            if (!itemText) {
                showAlert('請輸入待辦事項內容', 'error');
                return;
            }

            if (!checklistData[category]) {
                checklistData[category] = [];
            }

            checklistData[category].push({
                text: itemText,
                completed: false
            });

            // 儲存到 localStorage
            localStorage.setItem('tokyo-checklist', JSON.stringify(checklistData));

            // 重新渲染該分類
            renderChecklistCategory(category);

            // 清空輸入框
            newItemInput.value = '';
            
            showAlert('待辦事項已新增', 'success');
        }

        // 切換待辦事項完成狀態
        function toggleChecklistItem(category, index) {
            if (typeof checklistData[category][index] === 'string') {
                // 轉換舊格式為新格式
                checklistData[category][index] = {
                    text: checklistData[category][index],
                    completed: false
                };
            }

            checklistData[category][index].completed = !checklistData[category][index].completed;
            
            // 儲存到 localStorage
            localStorage.setItem('tokyo-checklist', JSON.stringify(checklistData));

            // 重新渲染該分類
            renderChecklistCategory(category);
        }

        // 刪除待辦事項
        function deleteChecklistItem(category, index) {
            if (confirm('確定要刪除這個待辦事項嗎？')) {
                checklistData[category].splice(index, 1);
                
                // 儲存到 localStorage
                localStorage.setItem('tokyo-checklist', JSON.stringify(checklistData));

                // 重新渲染該分類
                renderChecklistCategory(category);
                
                showAlert('待辦事項已刪除', 'success');
            }
        }

        // 載入旅遊筆記
        function loadNotes() {
            // 從 localStorage 載入筆記
            const savedNotes = localStorage.getItem('tokyo-notes');
            notesData = savedNotes ? JSON.parse(savedNotes) : [];

            renderNotes();
        }

        // 渲染筆記列表
        function renderNotes() {
            const notesContainer = document.getElementById('notes-list');
            
            if (notesData.length === 0) {
                notesContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">尚無旅遊筆記，開始記錄你的東京之旅吧！</p>';
                return;
            }

            let html = '';
            notesData.forEach((note, index) => {
                html += `
                    <div class="note-item">
                        <h4>${note.title}</h4>
                        <div class="note-date">
                            <i class="fas fa-calendar"></i> ${note.date}
                        </div>
                        <div class="note-content">${note.content.replace(/\n/g, '<br>')}</div>
                        <div class="note-actions">
                            <button class="delete-note-btn" onclick="deleteNote(${index})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </div>
                    </div>
                `;
            });

            notesContainer.innerHTML = html;
        }

        // 儲存筆記
        function saveNote() {
            const titleInput = document.getElementById('note-title');
            const contentInput = document.getElementById('note-content');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || !content) {
                showAlert('請輸入筆記標題和內容', 'error');
                return;
            }

            const newNote = {
                title: title,
                content: content,
                date: new Date().toLocaleString('zh-TW'),
                id: Date.now()
            };

            notesData.unshift(newNote); // 新筆記放在最前面

            // 儲存到 localStorage
            localStorage.setItem('tokyo-notes', JSON.stringify(notesData));

            // 清空輸入框
            titleInput.value = '';
            contentInput.value = '';

            // 重新渲染筆記列表
            renderNotes();

            showAlert('筆記已儲存', 'success');
        }

        // 刪除筆記
        function deleteNote(index) {
            if (confirm('確定要刪除這則筆記嗎？')) {
                notesData.splice(index, 1);
                
                // 儲存到 localStorage
                localStorage.setItem('tokyo-notes', JSON.stringify(notesData));

                // 重新渲染筆記列表
                renderNotes();
                
                showAlert('筆記已刪除', 'success');
            }
        }

        // 分享行程功能
        function shareItinerary() {
            if (navigator.share) {
                // 使用原生分享 API
                navigator.share({
                    title: '東京五日遊行程',
                    text: '我的東京旅遊行程規劃，一起來看看吧！',
                    url: window.location.href
                }).then(() => {
                    showAlert('分享成功', 'success');
                }).catch((error) => {
                    console.log('分享失敗:', error);
                    fallbackShare();
                });
            } else {
                // 備用分享方式
                fallbackShare();
            }
        }

        // 備用分享方式
        function fallbackShare() {
            const url = window.location.href;
            const text = `東京五日遊行程 - ${url}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('連結已複製到剪貼簿', 'success');
                });
            } else {
                // 創建臨時文字區域
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('連結已複製到剪貼簿', 'success');
            }
        }

        // 離線下載功能
        function downloadOffline() {
            showLoading(true);

            // 準備離線資料
            const offlineData = {
                itinerary: ITINERARY_DATA,
                checklist: checklistData,
                notes: notesData,
                exportDate: new Date().toLocaleString('zh-TW')
            };

            // 創建 JSON 檔案
            const dataStr = JSON.stringify(offlineData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            // 創建下載連結
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = `東京旅遊行程_${new Date().toISOString().split('T')[0]}.json`;
            
            // 觸發下載
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            setTimeout(() => {
                showLoading(false);
                showAlert('行程資料已下載', 'success');
            }, 1000);
        }

        // 顯示載入動畫
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        // 顯示提示訊息
        function showAlert(message, type = 'success') {
            // 移除現有的提示訊息
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // 創建新的提示訊息
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;

            // 插入到主要內容區域的頂部
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);

            // 3秒後自動移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Google Apps Script API 呼叫函數
        async function callGASAPI(action, data = {}) {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        data: data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API 呼叫失敗:', error);
                showAlert('網路連線失敗，使用離線模式', 'error');
                return null;
            }
        }

        // 儲存資料到 Google Sheets (可選功能)
        async function saveToCloud() {
            const cloudData = {
                checklist: checklistData,
                notes: notesData,
                lastUpdate: new Date().toISOString()
            };

            const result = await callGASAPI('saveData', cloudData);
            
            if (result && result.success) {
                showAlert('資料已同步到雲端', 'success');
            } else {
                showAlert('雲端同步失敗，資料已儲存在本機', 'error');
            }
        }

        // 從雲端載入資料 (可選功能)
        async function loadFromCloud() {
            showLoading(true);
            
            const result = await callGASAPI('loadData');
            
            if (result && result.success && result.data) {
                checklistData = result.data.checklist || checklistData;
                notesData = result.data.notes || notesData;
                
                // 更新 localStorage
                localStorage.setItem('tokyo-checklist', JSON.stringify(checklistData));
                localStorage.setItem('tokyo-notes', JSON.stringify(notesData));
                
                // 重新渲染
                loadChecklist();
                renderNotes();
                
                showAlert('雲端資料載入成功', 'success');
            }
            
            showLoading(false);
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S 儲存筆記
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'notes') {
                    saveNote();
                }
            }
            
            // Ctrl/Cmd + Enter 新增待辦事項
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'checklist') {
                    addChecklistItem();
                }
            }
            
            // 數字鍵 1-5 切換行程日期
            if (e.key >= '1' && e.key <= '5') {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'itinerary') {
                    const day = parseInt(e.key);
                    loadItinerary(day);
                }
            }
        });

        // PWA 支援 (Service Worker)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // 自動儲存功能
        setInterval(function() {
            // 每30秒自動儲存到 localStorage
            localStorage.setItem('tokyo-checklist', JSON.stringify(checklistData));
            localStorage.setItem('tokyo-notes', JSON.stringify(notesData));
        }, 30000);

        // 頁面可見性變化時儲存資料
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                localStorage.setItem('tokyo-checklist', JSON.stringify(checklistData));
                localStorage.setItem('tokyo-notes', JSON.stringify(notesData));
            }
        });

        // 觸控手勢支援 (行動裝置)
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // 判斷是否為水平滑動
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'itinerary') {
                    if (diffX > 0 && currentDay < 5) {
                        // 向左滑動，下一天
                        loadItinerary(currentDay + 1);
                    } else if (diffX < 0 && currentDay > 1) {
                        // 向右滑動，上一天
                        loadItinerary(currentDay - 1);
                    }
                }
            }

            touchStartX = 0;
            touchStartY = 0;
        });

        // 深色模式切換
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('dark-mode', document.body.classList.contains('dark-mode'));
        }

        // 載入深色模式設定
        if (localStorage.getItem('dark-mode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // 匯出功能增強
        function exportToPDF() {
            showAlert('PDF 匯出功能開發中...', 'error');
            // 這裡可以整合 jsPDF 或其他 PDF 生成庫
        }

        // 語音備忘錄功能 (實驗性)
        function startVoiceMemo() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'zh-TW';

                recognition.start();

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('note-content').value += transcript;
                    showAlert('語音識別完成', 'success');
                };

                recognition.onerror = function(event) {
                    showAlert('語音識別失敗', 'error');
                };
            } else {
                showAlert('瀏覽器不支援語音識別', 'error');
            }
        }

        // 天氣資訊 (可選功能)
        async function getWeatherInfo() {
            // 這裡可以整合天氣 API
            showAlert('天氣資訊功能開發中...', 'error');
        }

        // 匯率轉換功能
        function convertCurrency(amount, fromCurrency = 'JPY', toCurrency = 'TWD') {
            // 模擬匯率 (實際應該呼叫匯率 API)
            const exchangeRates = {
                'JPY_TWD': 0.21,
                'TWD_JPY': 4.76
            };

            const rate = exchangeRates[`${fromCurrency}_${toCurrency}`];
            return rate ? (amount * rate).toFixed(0) : amount;
        }

        // 新增匯率顯示到預算計算器
        function updateBudgetWithExchangeRate() {
            const totalJPY = parseInt(document.getElementById('total-amount').textContent.replace(/[¥,]/g, ''));
            const totalTWD = convertCurrency(totalJPY, 'JPY', 'TWD');
            
            // 在預算摘要中顯示台幣金額
            const summaryDiv = document.querySelector('.budget-summary');
            let twdDisplay = summaryDiv.querySelector('.twd-amount');
            
            if (!twdDisplay) {
                twdDisplay = document.createElement('p');
                twdDisplay.className = 'twd-amount';
                summaryDiv.appendChild(twdDisplay);
            }
            
            twdDisplay.innerHTML = `約 NT$${parseInt(totalTWD).toLocaleString()}`;
        }

        // 修改預算計算函數以包含匯率
        const originalCalculateBudget = calculateBudget;
        calculateBudget = function() {
            originalCalculateBudget();
            updateBudgetWithExchangeRate();
        };

        // 初始化完成提示
        console.log('🗾 東京旅遊行程 App 已載入完成！');
        console.log('💡 小提示：');
        console.log('   - 使用數字鍵 1-5 快速切換行程日期');
        console.log('   - Ctrl+S 快速儲存筆記');
        console.log('   - Ctrl+Enter 快速新增待辦事項');
        console.log('   - 在行程頁面左右滑動可切換日期 (行動裝置)');
    </script>
</body>
</html>

            
            

